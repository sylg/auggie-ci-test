# Self-Healing CI with Auggie CLI
# Level 3: Automatically fix safe issues and create PRs for others

name: Self-Healing CI

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  analyze:
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      failure_type: ${{ steps.analyze.outputs.failure_type }}
      is_auto_fixable: ${{ steps.analyze.outputs.is_auto_fixable }}
      risk_level: ${{ steps.analyze.outputs.risk_level }}
      pr_number: ${{ steps.pr.outputs.number }}
      analysis: ${{ steps.analyze.outputs.analysis }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number -q '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get failed logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed-logs.txt 2>&1 || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze failure
        id: analyze
        run: |
          # Analyze and get structured output
          cat /tmp/failed-logs.txt | auggie --print "
          Analyze this CI failure and output ONLY valid JSON (no markdown, no explanation):
          {
            \"failure_type\": \"test_failure|type_error|lint_error|compilation_error|dependency_issue|infrastructure|flaky_test\",
            \"is_auto_fixable\": true|false,
            \"risk_level\": \"low|medium|high\",
            \"root_cause\": \"brief description\",
            \"file\": \"path/to/file.ts or null\",
            \"line\": number or null,
            \"suggested_fix\": \"description of fix\"
          }
          " > /tmp/analysis.json

          # Parse the JSON
          FAILURE_TYPE=$(cat /tmp/analysis.json | jq -r '.failure_type // "unknown"')
          IS_AUTO_FIXABLE=$(cat /tmp/analysis.json | jq -r '.is_auto_fixable // false')
          RISK_LEVEL=$(cat /tmp/analysis.json | jq -r '.risk_level // "high"')

          echo "failure_type=$FAILURE_TYPE" >> $GITHUB_OUTPUT
          echo "is_auto_fixable=$IS_AUTO_FIXABLE" >> $GITHUB_OUTPUT
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT

          # Save full analysis for later steps
          echo "analysis=$(cat /tmp/analysis.json | jq -c '.')" >> $GITHUB_OUTPUT
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_AUTH }}

  auto-fix:
    needs: analyze
    if: |
      needs.analyze.outputs.is_auto_fixable == 'true' &&
      needs.analyze.outputs.risk_level == 'low'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Get failed logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed-logs.txt 2>&1 || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply fix
        id: fix
        run: |
          # Use Auggie to fix the issue
          cat /tmp/failed-logs.txt | auggie "
          Fix this CI failure. The failure type is: ${{ needs.analyze.outputs.failure_type }}

          Apply the fix directly to the files. Only fix what's broken.
          Keep changes minimal and focused.
          "

          # Check if any files were changed
          if git diff --quiet; then
            echo "fixed=false" >> $GITHUB_OUTPUT
          else
            echo "fixed=true" >> $GITHUB_OUTPUT
          fi
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_AUTH }}

      - name: Verify fix
        if: steps.fix.outputs.fixed == 'true'
        id: verify
        run: |
          # Run the checks to verify the fix works
          npm run typecheck && npm run lint && npm test && npm run build
          echo "verified=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Commit and push fix
        if: steps.fix.outputs.fixed == 'true' && steps.verify.outputs.verified == 'true'
        run: |
          git config user.name "Auggie Bot"
          git config user.email "auggie@augmentcode.com"

          git add -A
          git commit -m "fix: auto-fix ${{ needs.analyze.outputs.failure_type }}

          Applied by Auggie CLI self-healing CI.

          Failure type: ${{ needs.analyze.outputs.failure_type }}
          Risk level: ${{ needs.analyze.outputs.risk_level }}"

          git push

      - name: Post success comment
        if: steps.fix.outputs.fixed == 'true' && steps.verify.outputs.verified == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.analyze.outputs.pr_number }},
              body: `## ‚úÖ Auto-Fix Applied

              **Failure type:** \`${{ needs.analyze.outputs.failure_type }}\`
              **Risk level:** \`${{ needs.analyze.outputs.risk_level }}\`

              The fix has been automatically applied and verified. CI should re-run shortly.

              ---
              *Fixed by [Auggie CLI](https://augmentcode.com) self-healing CI*`
            });

  create-fix-pr:
    needs: analyze
    if: |
      needs.analyze.outputs.is_auto_fixable == 'true' &&
      needs.analyze.outputs.risk_level == 'medium'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Get failed logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed-logs.txt 2>&1 || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply fix
        run: |
          cat /tmp/failed-logs.txt | auggie "
          Fix this CI failure. The failure type is: ${{ needs.analyze.outputs.failure_type }}
          Apply the fix directly to the files.
          "
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_AUTH }}

      - name: Create fix branch and PR
        if: ${{ !cancelled() }}
        run: |
          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "Auggie Bot"
          git config user.email "auggie@augmentcode.com"

          BRANCH_NAME="auggie-fix/${{ github.event.workflow_run.head_branch }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"

          git add -A
          git commit -m "fix: suggested fix for ${{ needs.analyze.outputs.failure_type }}"
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "üîß Suggested fix for CI failure" \
            --body "## Suggested Fix

          This PR contains a suggested fix for the CI failure in #${{ needs.analyze.outputs.pr_number }}.

          **Failure type:** \`${{ needs.analyze.outputs.failure_type }}\`
          **Risk level:** \`${{ needs.analyze.outputs.risk_level }}\`

          Please review the changes before merging.

          ---
          *Suggested by [Auggie CLI](https://augmentcode.com)*" \
            --base "${{ github.event.workflow_run.head_branch }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  report-only:
    needs: analyze
    if: |
      needs.analyze.outputs.is_auto_fixable == 'false' ||
      needs.analyze.outputs.risk_level == 'high'
    runs-on: ubuntu-latest

    steps:
      - name: Post analysis comment
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = JSON.parse('${{ needs.analyze.outputs.analysis }}');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.analyze.outputs.pr_number }},
              body: `## üîç Build Failure Analysis

              **Failure type:** \`${analysis.failure_type}\`
              **Risk level:** \`${analysis.risk_level}\`
              **Auto-fixable:** ${analysis.is_auto_fixable ? 'Yes' : 'No'}

              ### Root Cause
              ${analysis.root_cause}

              ${analysis.file ? `**File:** \`${analysis.file}\`${analysis.line ? `:${analysis.line}` : ''}` : ''}

              ### Suggested Fix
              ${analysis.suggested_fix}

              ---
              *This issue requires manual review. Analyzed by [Auggie CLI](https://augmentcode.com)*`
            });
