# Simplified Self-Healing CI using Auggie Commands
# All logic lives in .augment/commands/ci-heal.md

name: CI Heal (Command-Based)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  heal:
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number -q '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get failed logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed-logs.txt 2>&1 || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run CI Heal Command
        id: heal
        run: |
          # Run the /ci-heal command - all logic is in the command
          cat /tmp/failed-logs.txt | auggie --print "/ci-heal" 2>&1 | tee /tmp/heal-output.md

          # Check if files were changed
          if git diff --quiet; then
            echo "status=no-changes" >> $GITHUB_OUTPUT
          else
            echo "status=fixed" >> $GITHUB_OUTPUT
            git diff --stat
          fi
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_AUTH }}

      - name: Verify and commit fix
        if: steps.heal.outputs.status == 'fixed'
        id: verify
        run: |
          # Verify the fix
          if npm run typecheck && npm run lint && npm test && npm run build; then
            echo "verified=true" >> $GITHUB_OUTPUT

            # Commit and push
            git config user.name "Auggie Bot"
            git config user.email "auggie@augmentcode.com"
            git add -A
            git commit -m "fix: auto-heal CI failure

            Applied by Auggie /ci-heal command"
            git push
          else
            echo "verified=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Post result to PR
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const healOutput = fs.readFileSync('/tmp/heal-output.md', 'utf8');
            const status = '${{ steps.heal.outputs.status }}';
            const verified = '${{ steps.verify.outputs.verified }}';

            let emoji, title;
            if (status === 'fixed' && verified === 'true') {
              emoji = '‚úÖ';
              title = 'Auto-Fix Applied';
            } else if (status === 'fixed') {
              emoji = '‚ö†Ô∏è';
              title = 'Fix Attempted (Verification Failed)';
            } else {
              emoji = 'üîç';
              title = 'Analysis Complete';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: `## ${emoji} ${title}\n\n${healOutput}\n\n---\n*Powered by Auggie /ci-heal command*`
            });
