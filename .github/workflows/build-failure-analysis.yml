# Build Failure Analysis with Auggie CLI
# This workflow analyzes CI failures and posts root cause analysis to PRs

name: Build Failure Analysis

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  analyze-failure:
    # Only run if CI failed and it was triggered by a PR
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Auggie CLI
        run: npm install -g @augmentcode/auggie

      - name: Get failed logs
        id: logs
        run: |
          # Get the failed workflow run logs
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/failed-logs.txt 2>&1 || true

          # Also capture the workflow run details
          gh run view ${{ github.event.workflow_run.id }} --json jobs,conclusion > /tmp/run-details.json

          echo "logs_captured=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze failure with Auggie
        id: analyze
        run: |
          # Run Auggie analysis
          cat /tmp/failed-logs.txt | auggie --print "
          Analyze this CI build failure.

          IMPORTANT: Output ONLY your final analysis in clean markdown format.
          Do NOT include tool calls, intermediate steps, or debugging output.
          Do NOT include ANSI color codes or emoji indicators for tools.

          Provide a structured analysis with these sections:

          ### Failure Type
          One of: test_failure | type_error | lint_error | compilation_error | dependency_issue | infrastructure | flaky_test

          ### Root Cause
          Clear explanation of why the build failed.

          ### Failing File
          Path and line number if applicable.

          ### Auto-Fixable
          Yes or No, with brief explanation.

          ### Suggested Fix
          Code diff or steps to fix the issue.

          Be specific and reference actual file paths and line numbers from the logs.
          " 2>&1 | sed 's/\x1b\[[0-9;]*m//g' > /tmp/analysis-raw.md

          # Extract only the final analysis (after last tool result or from start if no tools)
          # Look for the structured headers and extract from there
          if grep -q "### Failure Type" /tmp/analysis-raw.md; then
            # Extract from the first "### Failure Type" to end
            sed -n '/### Failure Type/,$p' /tmp/analysis-raw.md > /tmp/analysis.md
          else
            # Fallback: just use the cleaned output
            cp /tmp/analysis-raw.md /tmp/analysis.md
          fi

          echo "analysis_complete=true" >> $GITHUB_OUTPUT
        env:
          AUGMENT_SESSION_AUTH: ${{ secrets.AUGMENT_SESSION_AUTH }}

      - name: Get PR number
        id: pr
        run: |
          # Find the PR associated with this workflow run
          PR_NUMBER=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number -q '.[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post analysis to PR
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.md', 'utf8');

            const body = `## üîç Build Failure Analysis

            ${analysis}

            ---
            *Analyzed by [Auggie CLI](https://augmentcode.com) ‚Ä¢ [View full logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });

      - name: Upload analysis artifact
        uses: actions/upload-artifact@v4
        with:
          name: failure-analysis
          path: |
            /tmp/analysis.md
            /tmp/failed-logs.txt
            /tmp/run-details.json
